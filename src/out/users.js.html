<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: users.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: users.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
const pool = require("../db");
const bcrypt = require('bcrypt');

module.exports = function(app)
{

    // Get all users
    app.get("/users", async (reqs, res) => {
        try {
            const allUsers = await pool.query("SELECT * FROM users");
            res.json(allUsers.rows);
        } catch (err) {
            console.error(err.message);
        }
    });

    // Get a user
    app.get("/users/:id", async (req, res) => {
        const { id } = req.params;
        try {
            const user = await pool.query("SELECT * FROM users WHERE id_user = $1", [id]);
            res.json(user.rows[0]);
        } catch (err) {
            console.error(err.message);
        }
    });




    // Create a user
    app.post("/users", async (req, res) => {
        try {
            //await
            const { email } = req.body;
            const { nom } = req.body; // SET NOM
            const { prenom } = req.body; // SET PRENOM
            const { password } = req.body; // SET PASSWORD
            const { classe } = req.body; // SET CLASSE

            const userExist = await pool.query("SELECT COUNT(*) FROM users WHERE email = $1", [email]);
            console.log();
            if(userExist.rows[0].count > 0){
                res.json(false);
            }else{
                encryptedPassword = await bcrypt.hash(password, 10);

                const newUser = await pool.query("INSERT INTO users (email,nom,prenom,password,classe) VALUES ($1,$2,$3,$4,$5) RETURNING *", [email,nom,prenom,encryptedPassword,classe]);
                console.log(newUser);
                res.json(newUser);
            }                        
        } catch (err) {
            console.error(err.message);
        }
    });
    //update a user
    app.put("/users/:id", async (req, res) => {
        try {
            const { id } = req.params; //WHERE
            const { email } = req.body; // SET EMAIL
            const { nom } = req.body; // SET NOM
            const { prenom } = req.body; // SET PRENOM
            const { password } = req.body; // SET PASSWORD
            const { classe } = req.body; // SET PASSWORD

            const updateUser = await pool.query("UPDATE users SET email = $1, nom = $2, prenom = $3, password = $4, classe = $5 where id_user = $6", [email, nom, prenom, password, classe, id]);
            res.json("Users Updated");
        } catch (err) {
            console.error(err.message);
        }

    });

    //delete a user
    app.delete("/users/:id", async (req, res) => {
        try {
            const { id } = req.params; //WHERE
            const deleteUser = await pool.query("DELETE FROM users where id_user = $1", [id]);
            res.json("Users delete");
        } catch (err) {
            console.error(err.message);
        }
    });

    /**
     * Route serving login form.
     * @name get/login
     * @function
     * @memberof module:routers/users~usersRouter
     * @inner
     * @param {string} path - Express path
     * @param {callback} middleware - Express middleware.
     */

    app.post("/login", async (req, res) => {
        try {
            //await
            const { email } = req.body;
            const { password } = req.body; // SET PASSWORD
            const verifUserExist = await pool.query("SELECT COUNT(*) FROM users WHERE email = $1", [email]);
            
            if(verifUserExist.rows[0].count > 0){
                const verifUserPassword = await pool.query("SELECT * FROM users WHERE email = $1", [email]);
                const validPassword = await bcrypt.compare(password, verifUserPassword.rows[0].password);
                if (validPassword){
                    res.json(verifUserPassword.rows[0].id_user);
                }else{
                    res.json(false);
                }
                console.log(verifUserPassword);
                
            } 
            
        } catch (err) {
            console.error(err.message);
        }
    });  


}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Thu Jun 16 2022 22:13:49 GMT+0400 (heure normale de Maurice)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
